{% extends "base.html" %}

{% block content %}
<div class="event-container">
    <div class="event-header-section">
        <div class="event-info">
            <h1 class="event-title">{{ event.title }}</h1>
            <div class="event-meta">
                <span class="event-category">{{ event.category }}</span>
                <span class="event-date">
                    <i class="fas fa-calendar"></i>
                    {{ event.event_date.strftime('%B %d, %Y') }}
                    {% if event.event_time %}
                        at {{ event.event_time.strftime('%I:%M %p') }}
                    {% endif %}
                </span>
                <span class="event-venue">
                    <i class="fas fa-map-marker-alt"></i>
                    {{ event.venue }}
                </span>
            </div>
        </div>

        <div class="event-actions">
            <a href="{{ url_for('main.edit_event', event_id=event.id) }}" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Edit Event
            </a>
            <a href="{{ url_for('main.event_qr_code', event_id=event.id) }}" class="btn btn-primary">
                <i class="fas fa-qrcode"></i> Download QR Code
            </a>
        </div>
    </div>

    <div class="event-stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-comment-alt"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number">{{ reviews|length }}</h3>
                <p class="stat-label">Total Reviews</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number">{{ "%.1f"|format(avg_rating) }}</h3>
                <p class="stat-label">Average Rating</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number">{{ "%.1f"|format(response_rate) }}%</h3>
                <p class="stat-label">Response Rate</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-download"></i>
            </div>
            <div class="stat-content">
                <a href="{{ url_for('main.export_event_reviews', event_id=event.id) }}" class="btn btn-secondary">
                    Export CSV
                </a>
            </div>
        </div>
    </div>

    <div class="event-tabs">
        <div class="tab-nav">
            <button class="tab-button active" data-tab="reviews">Reviews</button>
            <button class="tab-button" data-tab="analytics">Analytics</button>
            <button class="tab-button" data-tab="share">Share</button>
        </div>

        <div class="tab-content">
            <!-- Reviews Tab -->
            <div class="tab-pane active" id="reviews-tab">
                {% if reviews %}
                    <div class="reviews-container">
                        {% for review in reviews %}
                            <div class="review-card" data-review-id="{{ review.id }}">
                                <div class="review-header">
                                    <div class="review-author">
                                        <strong>{{ review.reviewer_name }}</strong>
                                        {% if review.attendee_type %}
                                            <span class="review-type">{{ review.attendee_type }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="review-rating">
                                        {% for i in range(1, 6) %}
                                            <i class="fas fa-star {% if i <= review.star_rating %}active{% endif %}"></i>
                                        {% endfor %}
                                    </div>
                                    <div class="review-date">
                                        {{ review.submitted_at.strftime('%m/%d/%Y') }}
                                    </div>
                                </div>

                                {% if review.review_text %}
                                    <div class="review-text">
                                        {{ review.review_text }}
                                    </div>
                                {% endif %}

                                {% if review.get_categories() %}
                                    <div class="review-categories">
                                        {% for category in review.get_categories() %}
                                            <span class="category-tag">{{ category }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <div class="review-actions">
                                    <button class="btn btn-small btn-secondary feature-btn" data-review-id="{{ review.id }}">
                                        <i class="fas fa-star"></i>
                                        {% if review.is_featured %}Unfeature{% else %}Feature{% endif %}
                                    </button>
                                    <button class="btn btn-small btn-danger delete-btn" data-review-id="{{ review.id }}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-comment-alt"></i>
                        </div>
                        <h3 class="empty-title">No Reviews Yet</h3>
                        <p class="empty-text">Share your event link to start receiving reviews!</p>
                    </div>
                {% endif %}
            </div>

            <!-- Analytics Tab -->
            <div class="tab-pane" id="analytics-tab">
                <div class="analytics-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">Rating Distribution</h3>
                        <div class="rating-chart">
                            {% for rating in range(5, 0, -1) %}
                                <div class="rating-bar">
                                    <span class="rating-label">{{ rating }} â˜…</span>
                                    <div class="bar-container">
                                        <div class="bar" style="width: {% if reviews|length > 0 %}{{ (rating_distribution[rating] / reviews|length * 100)|round(1) }}%{% else %}0%{% endif %}"></div>
                                        <span class="bar-count">{{ rating_distribution[rating] }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 class="chart-title">Event Summary</h3>
                        <div class="summary-stats">
                            <div class="summary-item">
                                <span class="summary-label">Event Status</span>
                                <span class="summary-value status-{{ event.status }}">{{ event.status|title }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Expected Capacity</span>
                                <span class="summary-value">{{ event.capacity or 'Not Set' }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Recommendation Rate</span>
                                <span class="summary-value">
                                    {% set recommend_count = reviews|selectattr('would_recommend')|list|length %}
                                    {% if reviews|length > 0 %}
                                        {{ ((recommend_count / reviews|length) * 100)|round(1) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Share Tab -->
            <div class="tab-pane" id="share-tab">
                <div class="share-container">
                    <div class="share-section">
                        <h3 class="share-title">Review Link</h3>
                        <div class="share-item">
                            <input type="text" class="form-input" id="review-url" 
                                   value="{{ request.url_root.rstrip('/') }}{{ event.get_review_url() }}" readonly>
                            <button class="btn btn-secondary copy-btn" data-target="review-url">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>

                    <div class="share-section">
                        <h3 class="share-title">QR Code</h3>
                        <div class="qr-preview">
                            <p>Download the QR code to share with attendees</p>
                            <a href="{{ url_for('main.event_qr_code', event_id=event.id) }}" class="btn btn-primary">
                                <i class="fas fa-qrcode"></i> Download QR Code
                            </a>
                        </div>
                    </div>

                    <div class="share-section">
                        <h3 class="share-title">Share Text</h3>
                        <div class="share-item">
                            <textarea class="form-textarea" id="share-text" readonly>Please take a moment to review "{{ event.title }}" - your feedback is valuable! {{ request.url_root.rstrip('/') }}{{ event.get_review_url() }}</textarea>
                            <button class="btn btn-secondary copy-btn" data-target="share-text">
                                <i class="fas fa-copy"></i> Copy Text
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
// Tab functionality
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
        const tabName = button.getAttribute('data-tab');

        // Remove active class from all tabs and buttons
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

        // Add active class to clicked button and corresponding tab
        button.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
    });
});

// Copy functionality
document.querySelectorAll('.copy-btn').forEach(button => {
    button.addEventListener('click', () => {
        const targetId = button.getAttribute('data-target');
        const target = document.getElementById(targetId);
        target.select();
        document.execCommand('copy');

        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.classList.add('btn-success');

        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
        }, 2000);
    });
});

// Review management
document.querySelectorAll('.feature-btn').forEach(button => {
    button.addEventListener('click', () => {
        const reviewId = button.getAttribute('data-review-id');
        fetch(`/api/review/${reviewId}/feature`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const icon = button.querySelector('i');
                    const text = button.childNodes[1];
                    if (data.is_featured) {
                        icon.className = 'fas fa-star';
                        text.textContent = ' Unfeature';
                        button.classList.add('featured');
                    } else {
                        icon.className = 'far fa-star';
                        text.textContent = ' Feature';
                        button.classList.remove('featured');
                    }
                    showAlert('success', data.message);
                }
            });
    });
});

document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this review?')) {
            const reviewId = button.getAttribute('data-review-id');
            fetch(`/api/review/${reviewId}/delete`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector(`[data-review-id="${reviewId}"]`).remove();
                        showAlert('success', data.message);
                    }
                });
        }
    });
});
</script>
{% endblock %}
