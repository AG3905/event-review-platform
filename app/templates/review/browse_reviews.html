{% extends "base.html" %}

{% block content %}
<div class="browse-container">
    <div class="event-header">
        <h1 class="event-title">{{ event.title }}</h1>
        <div class="event-meta">
            <span class="event-category">{{ event.category }}</span>
            <span class="event-date">
                <i class="fas fa-calendar"></i>
                {{ event.event_date.strftime('%B %d, %Y') }}
            </span>
            <span class="event-venue">
                <i class="fas fa-map-marker-alt"></i>
                {{ event.venue }}
            </span>
        </div>
    </div>

    <div class="reviews-summary">
        <div class="summary-stats">
            <div class="summary-rating">
                <div class="rating-display">
                    <span class="rating-number">{{ "%.1f"|format(avg_rating) }}</span>
                    <div class="rating-stars">
                        {% for i in range(1, 6) %}
                            <i class="fas fa-star {% if i <= avg_rating %}active{% endif %}"></i>
                        {% endfor %}
                    </div>
                </div>
                <p class="rating-text">{{ reviews|length }} review{{ 's' if reviews|length != 1 else '' }}</p>
            </div>

            <div class="rating-breakdown">
                {% for rating in range(5, 0, -1) %}
                    <div class="rating-bar">
                        <span class="rating-label">{{ rating }}â˜…</span>
                        <div class="bar-container">
                            <div class="bar" style="width: {% if reviews|length > 0 %}{{ (rating_distribution[rating] / reviews|length * 100)|round(1) }}%{% else %}0%{% endif %}"></div>
                        </div>
                        <span class="bar-count">{{ rating_distribution[rating] }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if reviews %}
        <div class="reviews-list">
            <div class="reviews-header">
                <h2 class="reviews-title">All Reviews</h2>
                <div class="reviews-sort">
                    <select class="form-select" id="sortReviews">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="highest">Highest Rating</option>
                        <option value="lowest">Lowest Rating</option>
                    </select>
                </div>
            </div>

            <div class="reviews-container" id="reviewsContainer">
                {% for review in reviews %}
                    <div class="review-card" data-rating="{{ review.star_rating }}" data-date="{{ review.submitted_at.timestamp() }}">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <strong class="reviewer-name">{{ review.reviewer_name }}</strong>
                                {% if review.attendee_type %}
                                    <span class="reviewer-type">{{ review.attendee_type }}</span>
                                {% endif %}
                            </div>
                            <div class="review-meta">
                                <div class="review-rating">
                                    {% for i in range(1, 6) %}
                                        <i class="fas fa-star {% if i <= review.star_rating %}active{% endif %}"></i>
                                    {% endfor %}
                                </div>
                                <span class="review-date">{{ review.submitted_at.strftime('%B %d, %Y') }}</span>
                            </div>
                        </div>

                        {% if review.review_text %}
                            <div class="review-text">
                                {{ review.review_text }}
                            </div>
                        {% endif %}

                        {% if review.get_categories() %}
                            <div class="review-categories">
                                {% for category in review.get_categories() %}
                                    <span class="category-tag">{{ category }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if review.would_recommend %}
                            <div class="review-recommendation">
                                <i class="fas fa-thumbs-up"></i>
                                <span>Would recommend</span>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-comment-alt"></i>
            </div>
            <h3 class="empty-title">No Reviews Yet</h3>
            <p class="empty-text">Be the first to share your experience!</p>
            <a href="{{ url_for('main.review_form', unique_code=event.unique_code) }}" class="btn btn-primary">
                Write First Review
            </a>
        </div>
    {% endif %}

    <div class="browse-actions">
        {% if event.allow_reviews %}
            <a href="{{ url_for('main.review_form', unique_code=event.unique_code) }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Write a Review
            </a>
        {% endif %}
    </div>
</div>

{% block scripts %}
<script>
// Sort functionality
document.getElementById('sortReviews').addEventListener('change', (e) => {
    const sortType = e.target.value;
    const container = document.getElementById('reviewsContainer');
    const reviews = Array.from(container.children);

    reviews.sort((a, b) => {
        switch (sortType) {
            case 'newest':
                return parseFloat(b.dataset.date) - parseFloat(a.dataset.date);
            case 'oldest':
                return parseFloat(a.dataset.date) - parseFloat(b.dataset.date);
            case 'highest':
                return parseInt(b.dataset.rating) - parseInt(a.dataset.rating);
            case 'lowest':
                return parseInt(a.dataset.rating) - parseInt(b.dataset.rating);
            default:
                return 0;
        }
    });

    reviews.forEach(review => container.appendChild(review));
});
</script>
{% endblock %}
